"use strict";(self.webpackChunkdefra=self.webpackChunkdefra||[]).push([[7076],{20148:function(e,t,n){n.d(t,{SelfSnappingEngine:function(){return O}});var i=n(53804),r=n(83525),s=n(78879),o=n(23502),h=(n(58941),n(40633),n(13798),n(65953)),a=n(16691),c=n(56275),d=n(32501),l=n(68945),p=n(28397),f=n(62938),g=n(13786),u=n(21267),x=n(44425),v=n(95749);class E{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=u.N.shortLineThreshold*u.N.shortLineThreshold}snap(e,t){return null!=t.vertexHandle?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold((0,p.Lp)(e.leftVertex.pos,this.view,t),(0,p.Lp)(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:n}){return 0===this.squaredShortLineThreshold||(0,x.pM)((0,v.j)(t,n,l.qt,this.view),(0,v.j)(e,n,l.qt,this.view))>this.squaredShortLineThreshold}isVertical(e,t,{spatialReference:n}){const i=(0,f.GA)(n);return(0,g.Io)((0,p.Xz)(e),(0,p.Xz)(t))*i<u.N.verticalLineThresholdMeters}squaredProximityThreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}}var L=n(60100),w=n(99675),_=n(1428),V=n(94652),m=n(77363);class y extends E{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],i=n.edges.length,r=[];if(i<1)return r;const{spatialReference:s}=t,o=(0,v.j)(e,s,l.qt,this.view),{view:h}=this,a=n.edges[i-1];let c=a;do{if(this.edgeExceedsShortLineThreshold(c,t)){const n=(0,x.is)(c,h,t);this._processCandidateProposal(n.left,n.right,e,o,t,r)}c=c.leftVertex.leftEdge}while(c&&c!==a);return r}snapExistingVertex(e,t){const n=[],i=t.vertexHandle,r=i.component;if(r.edges.length<2)return n;const{view:s}=this,{spatialReference:o}=t,h=(0,v.j)(e,o,l.qt,s),a=i.leftEdge,c=i.rightEdge;a&&c&&this.edgeExceedsShortLineThreshold(a,t)&&this.edgeExceedsShortLineThreshold(c,t)&&this._processCandidateProposal((0,p.Lp)(a.leftVertex.pos,s,t),(0,p.Lp)(c.rightVertex.pos,s,t),e,h,t,n);const d=r.edges[0];let f=d;do{if(f!==i.leftEdge&&f!==i.rightEdge&&this.edgeExceedsShortLineThreshold(f,t)){const i=(0,x.is)(f,s,t);this._processCandidateProposal(i.left,i.right,e,h,t,n)}f=f.rightVertex.rightEdge}while(f&&f!==d);return n}_processCandidateProposal(e,t,n,i,r,s){const{spatialReference:o,pointer:h}=r,f=(0,d.vt)();!function(e,t,n,i,r){(function(e,t,n,i,{spatialReference:r}){const s=(0,w.IP)(t,n,r,r);if(null==s)return!1;const o=(0,w.IP)(n,i,r,r);if(null==o)return!1;const h=(0,_.n3)(n,i,r);if(null==h)return!1;const d=Math.abs(a.wf.shortestSignedDiff(s,o))>Math.PI/2?a.uC.normalize(s+Math.PI):s;return(0,w.rT)(e,n,r,(0,c.l3)(h,"meters"),(0,c.Wq)(d,"radians","geographic"),"geodesic"),e[2]=i[2],!0})(e,t,n,i,r)||function(e,t,n,i){(0,V.Yv)(t,{start:n,end:i,type:m.Vv.LINE},e),e[2]=t[2]}(e,i,t,n)}(f,e,t,n,r);const g=(0,p.de)((0,p._7)(f));(0,x.pM)(i,(0,v.j)(g,o,l.qt,this.view))<this.squaredProximityThreshold(h)&&s.push(new L.o({lineStart:e,lineEnd:t,targetPoint:g,isDraped:"on-the-ground"===r.elevationInfo?.mode}))}}var T=n(1932),P=n(87497);class S extends E{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],i=n.edges.length,r=n.vertices.length,s=[];if(i<2)return s;const{view:o}=this,h=(0,v.j)(e,t.spatialReference,l.qt,o),a=(0,p.Lp)(n.vertices[r-1].pos,o,t),c=(0,p.Lp)(n.vertices[0].pos,o,t),d=n.edges[i-1];let f=d;do{if(this.edgeExceedsShortLineThreshold(f,t)){const n=(0,x.is)(f,o,t);this._checkEdgeForParallelLines(n,a,e,h,t,s),this._checkEdgeForParallelLines(n,c,e,h,t,s)}f=f.leftVertex.leftEdge}while(f&&f!==d);return s}snapExistingVertex(e,t){const n=[],i=t.vertexHandle,r=i.component;if(r.edges.length<3)return n;const{view:s}=this,o=(0,v.j)(e,t.spatialReference,l.qt,s),h=i.leftEdge,a=i.rightEdge,c=r.vertices[0],d=(0,p.Lp)(c.pos,s,t),f=r.vertices.length,g=r.vertices[f-1],u=(0,p.Lp)(g.pos,s,t),E=r.edges[0];let L=E;do{if(L!==h&&L!==a&&this.edgeExceedsShortLineThreshold(L,t)){const r=(0,x.is)(L,s,t);h&&this._checkEdgeForParallelLines(r,(0,p.Lp)(h.leftVertex.pos,s,t),e,o,t,n),a&&this._checkEdgeForParallelLines(r,(0,p.Lp)(a.rightVertex.pos,s,t),e,o,t,n),i===c?this._checkEdgeForParallelLines(r,u,e,o,t,n):i===g&&this._checkEdgeForParallelLines(r,d,e,o,t,n)}L=L.rightVertex.rightEdge}while(L&&L!==E);return n}_checkEdgeForParallelLines(e,t,n,i,r,s){const o=e.left,h=e.right;if((0,m.fg)(z,(0,p.Xz)(t),(0,p.Xz)(o),(0,p.Xz)(h)),(0,g.hG)(z,(0,p.Xz)(t))<u.N.parallelLineThreshold)return;(0,m.fg)(z,(0,p.Xz)(n),(0,p.Xz)(o),(0,p.Xz)(h),(0,p.Xz)(t));const{spatialReference:a,pointer:c}=r,d=(0,p.de)((0,p.fA)(z[0],z[1],n[2]));if((0,x.pM)(i,(0,v.j)(d,a,l.qt,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(d,t,r)||this.isVertical(o,h,r))return;if(function(e,t){const n=e.left,i=e.right;for(const r of t)if((0,m.fg)(z,(0,p.Xz)(i),(0,p.Xz)(r.constraint.start),(0,p.Xz)(r.constraint.end),(0,p.Xz)(n)),(0,g.hG)(z,(0,p.Xz)(i))<u.N.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}(e,s))return;s.push(new P.B({referenceLine:e,lineStart:t,targetPoint:d,isDraped:"on-the-ground"===r.elevationInfo?.mode}))}}}const z=(0,T.vt)();var q=n(20551),X=n(92100),R=n(26373);class C extends E{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],i=[];if(n.vertices.length<2)return i;const{view:r}=this,s=(0,v.j)(e,t.spatialReference,l.qt,r),o=n.vertices.at(-1);this._checkForSnappingCandidate(R._b.LastVertex,i,o.leftEdge,o,o.leftEdge.leftVertex,e,s,t);const h=n.vertices[0];return this._checkForSnappingCandidate(R._b.FirstVertex,i,h.rightEdge,h,h.rightEdge.rightVertex,e,s,t),i}snapExistingVertex(e,t){const n=[],i=t.vertexHandle;if(i.component.vertices.length<3)return n;const{view:r}=this,s=(0,v.j)(e,t.spatialReference,l.qt,r),o=i.leftEdge,h=i.rightEdge;if(o?.leftVertex.leftEdge){const i=o.leftVertex.leftEdge;this._checkForSnappingCandidate(R._b.ExistingEdge,n,i,i.rightVertex,i.leftVertex,e,s,t)}if(h?.rightVertex.rightEdge){const i=h.rightVertex.rightEdge;this._checkForSnappingCandidate(R._b.ExistingEdge,n,i,i.leftVertex,i.rightVertex,e,s,t)}return n}_checkForSnappingCandidate(e,t,n,i,r,s,o,h){if(!this.edgeExceedsShortLineThreshold(n,h))return;const l=this.view,f=(0,p.Lp)(i.pos,l,h),u=(0,p.Lp)(r.pos,l,h);(function(e,t,n,i,r){(function(e,t,n,i,{spatialReference:r}){const s=(0,w.IP)(t,n,r,r);if(null==s)return!1;const o=(0,w.IP)(n,i,r,r);if(null==o)return!1;const h=Math.sign(a.uC.shortestSignedDiff(s,o))*Math.PI*.5,l=(0,c.Wq)(s+h,"radians","geographic"),p=(0,d.vt)(),f=(0,_.n3)(n,i,r);return null!=f&&((0,w.rT)(p,n,r,(0,c.l3)(f,"meters"),l,"geodesic"),(0,q.d)(e,p,n),!0)})(e,t,n,i,r)||function(e,t,n){const i=(0,g.Re)(M,(0,p.Xz)(n),(0,p.Xz)(t));(0,q.i)(e,i[1],-i[0],0)}(e,t,n)})(k,u,f,s,h),this._checkForSnappingCandidateAlongProjectedRay(e,t,u,f,k,s,o,h)}_checkForSnappingCandidateAlongProjectedRay(e,t,n,i,r,s,o,h){const{spatialReference:a,pointer:c}=h,f=(0,g.Re)(M,(0,p.Xz)(s),(0,p.Xz)(i)),u=(0,g.Om)(r,f)/(0,g.m3)(r),E=(0,g.Ln)(M,(0,p.Xz)(i),r,u),L=(0,p.de)((0,p.fA)(E[0],E[1],s[2]));if((0,x.pM)(o,(0,v.j)(L,a,l.qt,this.view))>this.squaredProximityThreshold(c)||this.isVertical(L,i,h)||this.isVertical(i,n,h))return;const w=(0,q.b)((0,d.vt)(),i,r,Math.sign(u));t.push(new R.HJ({targetPoint:L,constraint:new X.FX(i,(0,p._7)(w)),previousVertex:n,otherVertex:i,otherVertexType:R.pn.CENTER,selfSnappingType:e,isDraped:"on-the-ground"===h.elevationInfo?.mode}))}}const M=(0,T.vt)(),k=(0,d.vt)();var F=n(77173);class j extends E{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],i=[],r=n.vertices.length;if("polygon"!==t.editGeometryOperations.data.type||r<2)return i;const{view:s}=this,o=n.vertices[0],h=n.vertices[r-1],a=(0,p.Lp)(o.pos,s,t),c=(0,p.Lp)(h.pos,s,t);return this._processCandidateProposal(a,c,e,t,i),i}snapExistingVertex(e,t){const n=[],i=t.vertexHandle,r=i.component;if(r.edges.length<2)return n;if("polyline"===t.editGeometryOperations.data.type&&(0===i.index||i.index===r.vertices.length-1))return n;const{view:s}=this,o=(0,p.Lp)(i.leftEdge.leftVertex.pos,s,t),h=(0,p.Lp)(i.rightEdge.rightVertex.pos,s,t);return this._processCandidateProposal(o,h,e,t,n),n}_processCandidateProposal(e,t,n,i,r){if(!this.exceedsShortLineThreshold(e,t,i))return;const s=(0,g.Cc)(I,(0,p.Xz)(e),(0,p.Xz)(t),.5),o=.5*(0,g.Io)((0,p.Xz)(e),(0,p.Xz)(t)),h=(0,m.Dh)(I,(0,p.Xz)(n),s,o),a=(0,p.de)((0,p.fA)(h[0],h[1],n[2])),{spatialReference:c,pointer:d}=i,f=(0,v.j)(n,c,l.qt,this.view);if((0,x.pM)(f,(0,v.j)(a,c,l.qt,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(e,a,i)||this.isVertical(a,t,i))return;r.push(new F.R({targetPoint:a,point1:e,point2:t,isDraped:"on-the-ground"===i.elevationInfo?.mode}))}}}const I=(0,T.vt)();var N=n(34618);let O=class extends r.A{constructor(e){super(e),this.updating=!1,this._snappers=new s.A,this._domain=N.n.SELF}initialize(){this._snappers.push(new S(this.view,this.options),new y(this.view,this.options),new C(this.view,this.options),new j(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,n){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const t of this._snappers.items)for(const r of t.snap(e,n))i.push(r);return(0,x.xX)(e,i),i}};(0,i._)([(0,o.MZ)({readOnly:!0})],O.prototype,"updating",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],O.prototype,"view",void 0),(0,i._)([(0,o.MZ)()],O.prototype,"options",null),O=(0,i._)([(0,h.$)("esri.views.interactive.snapping.SelfSnappingEngine")],O)},1428:function(e,t,n){n.d(t,{Og:function(){return d},mh:function(){return c},n3:function(){return l}});var i=n(56275),r=n(32501),s=n(22162),o=n(57862),h=n(57652),a=n(99368);function c(e){const{spatialReference:t}=e;return(0,a.M0)(t,g,u,e)}function d(e,t){if(!(0,h.aI)(e.spatialReference,t.spatialReference))return null;const{spatialReference:n}=e;return v[0]=e.x,v[1]=e.y,v[2]=e.hasZ?e.z:0,E[0]=t.x,E[1]=t.y,E[2]=t.hasZ?t.z:0,l(v,E,n)}function l(e,t,n){return(0,a.M0)(n,p,f,e,t,n)}function p(e,t,n){return(0,i.d_)((0,o._3)(x,e,t,n).distance,"meters")}function f(e,t,n){return(0,i.d_)((0,s.geodesicLength)(function(e,t,n){return{type:"polyline",spatialReference:n,paths:[[[...e],[...t]]]}}(e,t,n),"meters"),"meters")}function g(e){return(0,i.d_)((0,o.l1)([e],"meters")[0],"meters")}function u(e){return(0,i.d_)((0,s.geodesicLength)(e,"meters"),"meters")}const x=new o.Zj,v=(0,r.vt)(),E=(0,r.vt)()},99368:function(e,t,n){n.d(t,{M0:function(){return o},yF:function(){return s}});var i=n(57862),r=n(57652);function s(e){return(0,i.TT)(e)||(0,r.K8)(e)}function o(e,t,n,...s){return(0,i.TT)(e)?t.apply(void 0,s):(0,r.K8)(e)?n.apply(void 0,s):null}}}]);
//# sourceMappingURL=SelfSnappingEngine.js.map