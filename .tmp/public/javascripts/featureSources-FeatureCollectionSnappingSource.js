"use strict";(self.webpackChunkdefra=self.webpackChunkdefra||[]).push([[8737],{99680:function(t,e,i){i.d(e,{q:function(){return s}});var n=i(85408);class s{constructor(t,e){this._storage=new n.F,this.id="",this.name="",this.size=0,this._storage.maxSize=t,this._storage.register(this),e&&this._storage.registerRemoveFunc("",e)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(t,e,i=1){this._storage.put(this,t,e,i,1)}pop(t){return this._storage.pop(this,t)}get(t){return this._storage.get(this,t)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}resetHitRate(){}}},85408:function(t,e,i){i.d(e,{F:function(){return c},Ti:function(){return s}});var n=i(7187);const s=-3,r=s-1;var o,a;(a=o||(o={}))[a.ALL=0]="ALL",a[a.SOME=1]="SOME";class c{get size(){return this._size}constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new n.A,this._users=new n.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,e){this._removeFuncs.push([t,e])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace((e=>e[0]!==t))}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,-1),this._checkSize()}getSize(t,e){const i=this._db.get(t.id+e);return i?.size??0}put(t,e,i,n,a){e=t.id+e;const c=this._db.get(e);if(c&&(this._size-=c.size,t.size-=c.size,this._db.delete(e),c.entry!==i&&this._notifyRemove(e,c.entry,c.size,o.ALL)),n>this._maxSize)return void this._notifyRemove(e,i,n,o.ALL);if(void 0===i)return void console.warn("Refusing to cache undefined entry ");if(!n||n<0)return console.warn(`Refusing to cache entry with size ${n} for key ${e}`),void this._notifyRemove(e,i,0,o.ALL);const u=1+Math.max(a,r)-s;this._db.set(e,new h(i,n,u)),this._size+=n,t.size+=n,this._checkSize()}updateSize(t,e,i,n){e=t.id+e;const s=this._db.get(e);if(s&&s.entry===i){for(this._size-=s.size,t.size-=s.size;n>this._maxSize;){const t=this._notifyRemove(e,i,n,o.SOME);if(!(null!=t&&t>0))return void this._db.delete(e);n=t}s.size=n,this._size+=n,t.size+=n,this._checkSize()}}pop(t,e){e=t.id+e;const i=this._db.get(e);if(i)return this._size-=i.size,t.size-=i.size,this._db.delete(e),++this._hit,i.entry;++this._miss}get(t,e){e=t.id+e;const i=this._db.get(e);if(void 0!==i)return this._db.delete(e),i.lives=i.lifetime,this._db.set(e,i),++this._hit,i.entry;++this._miss}peek(t,e){const i=this._db.get(t.id+e);return i?++this._hit:++this._miss,i?.entry}get performanceInfo(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},e={},i=new Array;this._db.forEach(((t,n)=>{const s=t.lifetime;i[s]=(i[s]||0)+t.size,this._users.forAll((i=>{const{id:s,name:r}=i;if(n.startsWith(s)){const i=e[r]||0;e[r]=i+t.size}}))}));const n={};this._users.forAll((t=>{const i=t.name;if("hitRate"in t&&"number"==typeof t.hitRate&&!isNaN(t.hitRate)&&t.hitRate>0){const s=e[i]||0;e[i]=s,n[i]=Math.round(100*t.hitRate)+"%"}else n[i]="0%"}));const r=Object.keys(e);r.sort(((t,i)=>e[i]-e[t])),r.forEach((i=>t[i]=Math.round(e[i]/2**20)+"MB / "+n[i]));for(let e=i.length-1;e>=0;--e){const n=i[e];n&&(t["Priority "+(e+s-1)]=Math.round(n/this._size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll((t=>t.resetHitRate()))}clear(t){const e=t.id;this._db.forEach(((t,i)=>{i.startsWith(e)&&(this._size-=t.size,this._db.delete(i),this._notifyRemove(i,t.entry,t.size,o.ALL))})),t.size=0}clearAll(){this._db.forEach(((t,e)=>this._notifyRemove(e,t.entry,t.size,o.ALL))),this._users.forAll((t=>t.size=0)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,e,i,n){let s;return this._removeFuncs.some((r=>{if(t.startsWith(r[0])){const t=r[1](e,n,i);return"number"==typeof t&&(s=t),!0}return!1})),s}_checkSize(){this._users.forAll((t=>this._checkSizeLimits(t))),this._checkSizeLimits()}_checkSizeLimits(t){const e=t??this;if(e.maxSize<0||e.size<=e.maxSize)return;const i=t?.id;let n=!0;for(;n;){n=!1;for(const[s,r]of this._db)if(0===r.lifetime&&(!i||s.startsWith(i))){if(this._purgeItem(s,r,t),e.size<=.9*e.maxSize)return;n||=this._db.has(s)}}for(const[n,s]of this._db)if((!i||n.startsWith(i))&&(this._purgeItem(n,s,t),e.size<=.9*e.maxSize))return}_purgeItem(t,e,i=this._users.find((e=>t.startsWith(e.id)))){if(this._db.delete(t),e.lives<=1){this._size-=e.size,i&&(i.size-=e.size);const n=this._notifyRemove(t,e.entry,e.size,o.SOME);null!=n&&n>0&&(this._size+=n,i&&(i.size+=n),e.lives=e.lifetime,e.size=n,this._db.set(t,e))}else--e.lives,this._db.set(t,e)}}class h{constructor(t,e,i){this.entry=t,this.size=e,this.lifetime=i,this.lives=i}}},7213:function(t,e,i){function n(t){let e,i,n=[],s=!1;return function(...r){return s&&e===this&&function(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}(r,n)||(i=t.apply(this,r),e=this,n=r,s=!0),i}}i.d(e,{B:function(){return n}})},31392:function(t,e,i){i.d(e,{C:function(){return o}});var n=i(92100),s=i(29936),r=i(96942);class o extends s.w{constructor(t){super({...t,constraint:new n.i7(t.targetPoint)})}get hints(){return[new r._(this.targetPoint,this.isDraped,this.domain)]}}},66486:function(t,e,i){i.r(e),i.d(e,{FeatureCollectionSnappingSource:function(){return g}});var n=i(53804),s=i(83525),r=i(7213),o=i(60539),a=i(28181),c=i(23502),h=(i(58941),i(40633),i(13798),i(65953)),u=i(68945),l=i(44425),d=i(94750),p=i(71308),f=i(94139),_=i(22878);let g=class extends s.A{get availability(){return 1}get _snappingElevationAligner(){const{view:t}=this,{layer:e}=this.layerSource,i=null!=t&&"3d"===t.type;return i&&"subtype-group"!==e.type?(0,p.n)(i,{elevationInfo:e.elevationInfo,alignPointsInFeatures:async(i,n)=>(await(0,o.qr)(t.whenLayerView(e),n)).elevationAlignPointsInFeatures(i,n)}):(0,p.n)()}get _snappingElevationFilter(){const{view:t}=this,e=null!=t&&"3d"===t.type&&"subtype-group"!==this.layerSource.layer.type;return(0,f.z)(e)}get _symbologySnappingFetcher(){const{view:t}=this,{layer:e}=this.layerSource;return null!=t&&"3d"===t.type&&"subtype-group"!==e.type?(0,_.H)(this._symbologySnappingSupported,(async(i,n)=>{const s=await t.whenLayerView(e);return(0,o.Te)(n),s.queryForSymbologySnapping({candidates:i,spatialReference:t.spatialReference},n)})):(0,_.H)()}get _layerView3D(){const{view:t}=this;if(null==t||"2d"===t.type)return null;const{layer:e}=this.layerSource;return t.allLayerViews.find((t=>t.layer===e))}get _symbologySnappingSupported(){return null!=this._layerView3D&&this._layerView3D.symbologySnappingSupported}initialize(){const{view:t}=this,{layer:e}=this.layerSource;null!=t&&"3d"===t.type&&"subtype-group"!==e.type&&this.addHandles([t.elevationProvider.on("elevation-change",(({context:t})=>{const{elevationInfo:i}=e;(0,u.Up)(t,i)&&this._snappingElevationAligner.notifyElevationSourceChange()})),(0,a.watch)((()=>e.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),a.Vh),(0,a.watch)((()=>null!=this._layerView3D?this._layerView3D.layer?.renderer:null),(()=>this._symbologySnappingFetcher.notifySymbologyChange()),a.Vh),(0,a.on)((()=>this._layerView3D?.layer),["edits","apply-edits","graphic-update"],(()=>this._symbologySnappingFetcher.notifySymbologyChange()))])}constructor(t){super(t),this.view=null,this.updating=!1,this._memoizedMakeGetGroundElevation=(0,r.B)(d.p)}refresh(){}async fetchCandidates(t,e){const{layer:i}=this.layerSource,n=i.source;if(!n?.querySnapping)return[];const s=(0,l.HN)(i),r=(0,l.nf)(t,this.view?.type??"2d",s),a=await n.querySnapping(r,{signal:e});(0,o.Te)(e);const c=t.coordinateHelper.spatialReference,h=await this._snappingElevationAligner.alignCandidates(a.candidates,c,e);(0,o.Te)(e);const u=await this._symbologySnappingFetcher.fetch(h,e);(0,o.Te)(e);const p=0===u.length?h:[...h,...u],f=this._snappingElevationFilter.filter(r,p),_=this._memoizedMakeGetGroundElevation(this.view,c);return f.map((t=>(0,d.$)(t,_)))}};(0,n._)([(0,c.MZ)({constructOnly:!0})],g.prototype,"layerSource",void 0),(0,n._)([(0,c.MZ)({constructOnly:!0})],g.prototype,"view",void 0),(0,n._)([(0,c.MZ)()],g.prototype,"_snappingElevationAligner",null),(0,n._)([(0,c.MZ)()],g.prototype,"_snappingElevationFilter",null),(0,n._)([(0,c.MZ)()],g.prototype,"_symbologySnappingFetcher",null),(0,n._)([(0,c.MZ)()],g.prototype,"_layerView3D",null),(0,n._)([(0,c.MZ)()],g.prototype,"_symbologySnappingSupported",null),g=(0,n._)([(0,h.$)("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],g)},94750:function(t,e,i){i.d(e,{$:function(){return c},p:function(){return h}});var n=i(28397),s=i(52511),r=i(42937),o=i(31392);function a({x:t,y:e,z:i}){return(0,n.fA)(t,e,i??0)}function c(t,e){switch(t.type){case"edge":return t.draped?new s.X({edgeStart:a(t.start),edgeEnd:a(t.end),targetPoint:(0,n.de)(a(t.target)),objectId:t.objectId,getGroundElevation:e}):new r.z({edgeStart:a(t.start),edgeEnd:a(t.end),targetPoint:(0,n.de)(a(t.target)),objectId:t.objectId,isDraped:!1});case"vertex":return new o.C({targetPoint:(0,n.de)(a(t.target)),objectId:t.objectId,isDraped:!1})}}function h(t,e){return null!=t&&"3d"===t.type?(i,n)=>t.elevationProvider.getElevation(i,n,0,e,"ground"):()=>null}},71308:function(t,e,i){i.d(e,{n:function(){return c}}),i(58941);var n=i(99680),s=i(25738),r=i(60539),o=i(62938),a=i(32e3);function c(t=!1,e){if(t){const{elevationInfo:t,alignPointsInFeatures:i}=e;return new u(t,i)}return new h}class h{async alignCandidates(t,e,i){return t}notifyElevationSourceChange(){}}class u{constructor(t,e){this._elevationInfo=t,this._alignPointsInFeatures=e,this._alignmentsCache=new n.q(1024),this._cacheVersion=0}async alignCandidates(t,e,i){const n=this._elevationInfo;return null==n||"absolute-height"!==n.mode||n.featureExpressionInfo?this._alignComputedElevationCandidates(t,e,i):(function(t,e,i){const{offset:n,unit:s}=i;if(null==n)return;const r=(0,o.G9)(e),c=n*((0,a.Ao)(s??"meters")/r);for(const e of t)switch(e.type){case"edge":e.start.z+=c,e.end.z+=c;continue;case"vertex":e.target.z+=c;continue}}(t,e,n),t)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(t,e,i){const n=new Map;for(const e of t)(0,s.tE)(n,e.objectId,p).push(e);const[o,a,c]=this._prepareQuery(n,e),h=await this._alignPointsInFeatures(o,i);if((0,r.Te)(i),c!==this._cacheVersion)return this._alignComputedElevationCandidates(t,e,i);this._applyCacheAndResponse(o,h,a);const{drapedObjectIds:u,failedObjectIds:l}=h,d=[];for(const e of t){const{objectId:t}=e;u.has(t)&&"edge"===e.type&&(e.draped=!0),l.has(t)||d.push(e)}return d}_prepareQuery(t,e){const i=[],n=[];for(const[e,s]of t){const t=[];for(const i of s)this._addToQueriesOrCachedResult(e,i.target,t,n),"edge"===i.type&&(this._addToQueriesOrCachedResult(e,i.start,t,n),this._addToQueriesOrCachedResult(e,i.end,t,n));0!==t.length&&i.push({objectId:e,points:t})}return[{spatialReference:e.toJSON(),pointsInFeatures:i},n,this._cacheVersion]}_addToQueriesOrCachedResult(t,e,i,n){const s=d(t,e),r=this._alignmentsCache.get(s);null==r?i.push(e):n.push(new l(e,r))}_applyCacheAndResponse(t,{elevations:e,drapedObjectIds:i,failedObjectIds:n},s){for(const t of s)t.apply();let r=0;const o=this._alignmentsCache;for(const{objectId:s,points:a}of t.pointsInFeatures){if(n.has(s)){r+=a.length;continue}const t=!i.has(s);for(const i of a){const n=d(s,i),a=e[r++];i.z=a,t&&o.put(n,a,1)}}}}class l{constructor(t,e){this.point=t,this.z=e}apply(){this.point.z=this.z}}function d(t,{x:e,y:i,z:n,spatialReference:s}){return`${t}-${e}-${i}-${n??0}}-wkid:${s?.wkid}`}function p(){return[]}},94139:function(t,e,i){i.d(e,{z:function(){return o}}),i(58941);class n{filter(t,e){return e}notifyElevationSourceChange(){}}class s{filter(t,e){const{point:i,distance:n}=t,{z:s}=i;if(null==s)return e;if(0===e.length)return e;const o=function(t){return"number"==typeof t?{x:t,y:t,z:t}:t}(n),a=this._updateCandidatesTo3D(e,i,o).filter(r);return a.sort(h),a}_updateCandidatesTo3D(t,e,i){for(const n of t)switch(n.type){case"edge":a(n,e,i);continue;case"vertex":c(n,e,i);continue}return t}}function r(t){return t.distance<=1}function o(t=!1){return t?new s:new n}function a(t,e,{x:i,y:n,z:s}){const{start:r,end:o,target:a}=t;t.draped||function(t,e,i,n){const s=n.x-i.x,r=n.y-i.y,o=n.z-i.z,a=s*s+r*r+o*o,c=(e.x-i.x)*s+(e.y-i.y)*r+o*(e.z-i.z),h=Math.min(1,Math.max(0,c/a)),u=i.x+s*h,l=i.y+r*h,d=i.z+o*h;t.x=u,t.y=l,t.z=d}(a,e,r,o);const c=(e.x-a.x)/i,h=(e.y-a.y)/n,u=(e.z-a.z)/s;t.distance=Math.sqrt(c*c+h*h+u*u)}function c(t,e,{x:i,y:n,z:s}){const{target:r}=t,o=(e.x-r.x)/i,a=(e.y-r.y)/n,c=(e.z-r.z)/s,h=Math.sqrt(o*o+a*a+c*c);t.distance=h}function h(t,e){return t.distance-e.distance}},22878:function(t,e,i){i.d(e,{H:function(){return a}}),i(58941);var n=i(21609),s=i(99680),r=i(60539),o=i(50944);function a(t=!1,e){return t?new h(e):new c}class c{async fetch(){return[]}notifySymbologyChange(){}}class h{constructor(t){this._getSymbologyCandidates=t,this._candidatesCache=new s.q(1024),this._cacheVersion=0}async fetch(t,e){if(0===t.length)return[];const i=[],s=[],o=this._candidatesCache;for(const e of t){const t=u(e),r=o.get(t);if(r)for(const t of r)s.push((0,n.o8)(t));else i.push(e),o.put(t,[],1)}if(0===i.length)return s;const a=this._cacheVersion,{candidates:c,sourceCandidateIndices:h}=await this._getSymbologyCandidates(i,e);if((0,r.Te)(e),a!==this._cacheVersion)return this.fetch(t,e);const l=[],{length:d}=c;for(let t=0;t<d;++t){const e=c[t],s=u(i[h[t]]),r=o.get(s);r.push(e),o.put(s,r,r.length),l.push((0,n.o8)(e))}return s.concat(l)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function u(t){switch(t.type){case"vertex":{const{objectId:e,target:i}=t,n=`${e}-vertex-${i.x}-${i.y}-${i.z??0}`;return(0,o.Wm)(n).toString()}case"edge":{const{objectId:e,start:i,end:n}=t,s=`${e}-edge-${i.x}-${i.y}-${i.z??0}-to-${n.x}-${n.y}-${n.z??0}`;return(0,o.Wm)(s).toString()}default:return""}}},96942:function(t,e,i){i.d(e,{_:function(){return r}});var n=i(20551),s=i(94612);class r extends s.m{constructor(t,e,i){super(e,i),this.point=t}equals(t){return t instanceof r&&(0,n.p)(this.point,t.point)}}}}]);
//# sourceMappingURL=featureSources-FeatureCollectionSnappingSource.js.map